---
variables:
  DEBIAN_FRONTEND: "noninteractive"

  APTGET_INSTALL_FLAGS:
    value: ""
    description: "Flags to pass to apt-get"

  # Used by jobs other than than just python.yml
  # cf: https://gitlab.com/cappysan/images/container_registry/6574223
  PYTHON_JOB_IMAGE_NAMESPACE:
    value: "registry.gitlab.com/cappysan/images"
    description: "Docker namespace to use for building environments for version matrix"
  PYTHON_JOB_IMAGE:
    value: "$PYTHON_JOB_IMAGE_NAMESPACE/python:3.11"
    description: "Docker image to use for building environment"

# ------------------------------------------------------------------------------
# Reference parts
# ------------------------------------------------------------------------------
# The following section add functions to the bash executor of the image.
#   * we disable PS4 (used by `set -x`)
#   * we create functions to create collapsible timed sections
#   * we create some coloring functions
#
# Collapsible sections:
#   https://docs.gitlab.com/ee/ci/jobs/#custom-collapsible-sections
#
# Usage:
#   - !reference [".core:functions", script]
.core:functions:
  script:
    - |
      # !reference [".core:functions", script]
      set -e
      set -o pipefail
      export PS4=''
      # Sections
      section_start()    { echo -e "section_start:`date +%s`:${1}${3}\r\e[0K\e[34;1m${2}\e[0m"; }
      section_start_c()  { section_start "$1" "$2" "[collapsed=true]"; }
      section_start_nc() { section_start "$1" "$2" "[collapsed=false]"; }
      section_end()      { echo -e "section_end:`date +%s`:${1}\r\e[0K"; }
      # Titles are bluish like section starts
      color_title()      { echo -e "\e[1;34m"${@}"\e[0m"; }
      color_error()      { echo -e "\e[1;31m"${@}"\e[0m" >&2; }
      color_warning()    { echo -e "\e[1;33m"${@}"\e[0m" >&2; }
      #
      color_command()    { echo -e "\e[1;32m"\$ ${@}"\e[0m" >&2; }


# ------------------------------------------------------------------------------
# .core:prolog
# ------------------------------------------------------------------------------
# Print debugging info, notably details that allow
# to retrieve instance, project, pipeline and job
# from the raw log files on the server.
#
# Of interest: https://docs.gitlab.com/ci/variables/predefined_variables/
.core:prolog:
  script:
    - |
      # !reference [".core:prolog", script]
      section_start_c "core_prolog" "Core information"
      cat <<_EOF >&2
      Current:
        time:           $(date -R)
        server:         ${CI_SERVER_URL}
        project:        ${CI_PROJECT_URL}
        pipeline:       ${CI_PIPELINE_URL}
        job:            ${CI_JOB_URL}
        timeout:        ${CI_JOB_TIMEOUT}
        pipeline start: ${CI_PIPELINE_CREATED_AT}
        #
        source:         ${CI_PIPELINE_SOURCE}
        protected:      ${CI_COMMIT_REF_PROTECTED}
        #
        reference:      ${CI_COMMIT_REF_NAME}
        sha:            ${CI_COMMIT_SHA}
        tag name:       ${CI_COMMIT_TAG}
        default branch: ${CI_DEFAULT_BRANCH}
        #
        server version: ${CI_SERVER_VERSION}
        runner version: ${CI_RUNNER_VERSION}
        runner id:      ${CI_RUNNER_ID}
      _EOF
      section_end "core_prolog"

# ------------------------------------------------------------------------------
# .core:defaults
# ------------------------------------------------------------------------------
# cf. https://docs.gitlab.com/ee/ci/yaml/#default
.core:defaults:
  image: alpine
  needs: []
  before_script:
    - !reference [".core:functions", script]
    - !reference [".core:prolog",    script]
  rules:
    - when: never

# ------------------------------------------------------------------------------
# .core:make
# ------------------------------------------------------------------------------
.core:make:
  script:
    - |
      # !reference [".core:make", script]
      color_command make ${MAKEFILE_TARGET}
      make ${MAKEFILE_TARGET} ${MAKEFILE_FLAGS}

# ------------------------------------------------------------------------------
# .core:rules
# ------------------------------------------------------------------------------
.core:rules:if:
  # !reference [".core:rules:if", is_tag]
  is_tag:
    - if: $CI_COMMIT_TAG != null
      when: on_success

  # !reference [".core:rules:if", is_merge_request]
  is_merge_request:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: on_success

  # !reference [".core:rules:if", if_not_merge_request]
  if_not_merge_request:
    - if: $CI_PIPELINE_SOURCE != "merge_request_event"
      when: on_success

  # !reference [".core:rules:is", is_default_branch]
  is_default_branch:
    # Reference (branch/tag) must be protected, and this must not be a merge request
    - is: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: on_success

  # !reference [".core:rules:is", is_not_default_branch]
  is_not_default_branch:
    # Reference (branch/tag) must be protected, and this must not be a merge request
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      when: on_success

  # !reference [".core:rules:if", if_protected]
  if_protected:
    - if: $CI_COMMIT_REF_PROTECTED == "true"
      when: on_success

  # !reference [".core:rules:if", if_protected]
  if_not_protected:
    - if: $CI_COMMIT_REF_PROTECTED != "true"
      when: on_success

.core:rules:not_if:
  # !reference [".core:rules:not_if", pages_are_inactive]
  pages_are_inactive:
    - if: $CI_PAGES_URL == null
      when: never

  # !reference [".core:rules:not_if", is_tag]
  is_tag:
    - if: $CI_COMMIT_TAG != null
      when: never

  # !reference [".core:rules:not_if", is_merge_request]
  is_merge_request:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: never

  # !reference [".core:rules:not_if", if_not_merge_request]
  is_not_merge_request:
    - if: $CI_PIPELINE_SOURCE != "merge_request_event"
      when: never

  # !reference [".core:rules:is", is_protected]
  is_protected:
    - is: $CI_COMMIT_REF_PROTECTED == "true"
      when: never

  # !reference [".core:rules:not_if", not_if_protected]
  not_if_protected:
    - not_if: $CI_COMMIT_REF_PROTECTED != "true"
      when: never

  # !reference [".core:rules:not_if", is_default_branch]
  is_default_branch:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: never

  # !reference [".core:rules:not_if", is_not_default_branch]
  is_not_default_branch:
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      when: never

  # !reference [".core:rules:not_if", if_protected]
  is_protected:
    - if: $CI_COMMIT_REF_PROTECTED == "true"
      when: never

  # !reference [".core:rules:not_if", if_protected]
  is_not_protected:
    - if: $CI_COMMIT_REF_PROTECTED != "true"
      when: never
